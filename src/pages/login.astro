---
import AppLayout from '../layouts/AppLayout.astro';
const base = import.meta.env.BASE_URL;
---

<AppLayout title="Log In — XR Club">
  <div class="auth-page">
    <div class="auth-card">
      <img src={`${base}Images/XR logo.png`} alt="XR Club" class="auth-card__logo" />
      <h1 class="auth-card__title">Welcome Back</h1>
      <p class="auth-card__subtitle">Log in to your XR Club account</p>

      <div id="error-msg" class="auth-card__error" style="display:none;"></div>

      <form id="login-form" class="auth-form">
        <div class="auth-form__field">
          <label class="auth-form__label" for="email">Email</label>
          <input
            class="auth-form__input"
            type="email"
            id="email"
            name="email"
            placeholder="you@umd.edu"
            required
          />
        </div>

        <div class="auth-form__field">
          <label class="auth-form__label" for="password">Password</label>
          <input
            class="auth-form__input"
            type="password"
            id="password"
            name="password"
            placeholder="Your password"
            required
          />
        </div>

        <button type="submit" class="auth-form__btn" id="submit-btn">
          Log In
        </button>
      </form>

      <p class="auth-card__footer" style="margin-top:0.8rem;">
        <a href={`${base}forgot-password`} class="auth-card__link">Forgot password?</a>
      </p>
      <p class="auth-card__footer">
        Don't have an account? <a href={`${base}signup`} class="auth-card__link">Sign up</a>
      </p>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    const base = import.meta.env.BASE_URL;
    const form = document.getElementById('login-form') as HTMLFormElement;
    const errorMsg = document.getElementById('error-msg')!;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    const params = new URLSearchParams(window.location.search);
    const redirect = params.get('redirect') || `${base}apply`;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.style.display = 'none';

      const email = (document.getElementById('email') as HTMLInputElement).value.trim();
      const password = (document.getElementById('password') as HTMLInputElement).value;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="auth-spinner"></span>Logging in…';

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        errorMsg.textContent = error.message;
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Log In';
        return;
      }

      const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', data.user.id)
        .single();

      if (profile && (profile.role === 'board' || profile.role === 'admin')) {
        window.location.href = `${base}dashboard`;
      } else {
        window.location.href = redirect;
      }
    });

    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (profile && (profile.role === 'board' || profile.role === 'admin')) {
          window.location.href = `${base}dashboard`;
        } else {
          window.location.href = redirect;
        }
      }
    })();
  </script>
</AppLayout>
