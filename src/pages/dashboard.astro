---
import AppLayout from '../layouts/AppLayout.astro';
const base = import.meta.env.BASE_URL;
---

<AppLayout title="Dashboard — XR Club" hideHeader hideChatBot>
  <div class="auth-page" id="loading-state">
    <div class="auth-card" style="text-align:center;">
      <span class="auth-spinner"></span>
      <p class="auth-card__subtitle" style="margin-top:1rem;">Loading dashboard…</p>
    </div>
  </div>

  <div class="dash" id="dash" style="display:none;">
    <aside class="dash__sidebar">
      <div class="dash__sidebar-header">
        <div class="dash__user-name" id="user-name"></div>
        <div class="dash__user-role" id="user-role"></div>
      </div>

      <nav class="dash__nav">
        <div class="dash__nav-link dash__nav-link--active" data-tab="applications">Applications</div>
        <div class="dash__nav-link" data-tab="activity">Activity Log</div>
        <a href={base} class="dash__nav-link">Back to Site</a>
      </nav>

      <div class="dash__sidebar-footer">
        <button class="dash__logout" id="logout-btn">Sign Out</button>
      </div>
    </aside>

    <main class="dash__main">
      <div id="applications-view">
        <h1 class="dash__title">Applications</h1>

        <div class="dash__stats" id="stats-grid"></div>

        <div class="dash__bulk" id="bulk-bar">
          <span class="dash__bulk-count" id="bulk-count">0 selected</span>
          <select class="dash__bulk-select" id="bulk-status-select">
            <option value="">Change status to…</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="waitlisted">Waitlisted</option>
          </select>
          <button class="dash__bulk-btn" id="bulk-apply-btn">Apply</button>
        </div>

        <div class="dash__toolbar">
          <input class="dash__search" type="text" id="search-input" placeholder="Search by name, email, or major…" />
          <select class="dash__filter" id="filter-status">
            <option value="">All Statuses</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="waitlisted">Waitlisted</option>
            <option value="draft">In Progress</option>
          </select>
          <button class="dash__export-btn" id="export-btn">Export Excel</button>
        </div>

        <table class="dash__table" id="app-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" /></th>
              <th>Name</th>
              <th>Email</th>
              <th>Major</th>
              <th>Year</th>
              <th>Status</th>
              <th>Submitted</th>
            </tr>
          </thead>
          <tbody id="app-tbody"></tbody>
        </table>

        <div class="dash__empty" id="empty-msg" style="display:none;">No applications found.</div>
      </div>

      <div id="activity-view" class="dash__activity">
        <h1 class="dash__title">Activity Log</h1>
        <div id="activity-list"></div>
        <div class="dash__empty" id="activity-empty" style="display:none;">No activity yet.</div>
      </div>
    </main>

    <div class="dash__detail" id="detail-panel">
      <button class="dash__detail-close" id="detail-close">← Back</button>
      <div id="detail-content"></div>

      <div class="dash__detail-field">
        <div class="dash__detail-label">Status</div>
        <select class="dash__detail-status" id="detail-status">
          <option value="accepted">Accepted</option>
          <option value="rejected">Rejected</option>
          <option value="waitlisted">Waitlisted</option>
        </select>
      </div>

      <div class="dash__notes">
        <div class="dash__notes-title">Notes</div>
        <div id="notes-list"></div>
        <textarea class="dash__note-input" id="note-input" placeholder="Add a note…"></textarea>
        <button class="dash__note-btn" id="add-note-btn">Add Note</button>
      </div>

      <div class="dash__danger-zone">
        <button class="dash__delete-btn" id="delete-app-btn">Delete Application</button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';
    import type { Application, Profile } from '../lib/types';

    const base = import.meta.env.BASE_URL;
    let currentUser: Profile | null = null;
    let applications: (Application & { profiles?: { full_name: string; email: string } })[] = [];
    let selectedIds = new Set<string>();
    let openAppId: string | null = null;

    // DOM refs — refreshed on every page load
    let loadingState: HTMLElement;
    let dash: HTMLElement;
    let tbody: HTMLElement;
    let searchInput: HTMLInputElement;
    let filterStatus: HTMLSelectElement;
    let statsGrid: HTMLElement;
    let emptyMsg: HTMLElement;
    let selectAll: HTMLInputElement;
    let bulkBar: HTMLElement;
    let bulkCount: HTMLElement;
    let detailPanel: HTMLElement;

    function esc(s: string) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function loadApplications() {
      const { data } = await supabase
        .from('applications')
        .select('*, profiles(full_name, email)')
        .order('submitted_at', { ascending: false, nullsFirst: false });

      applications = (data || []) as typeof applications;
      renderTable();
    }

    async function loadStats() {
      const statuses = ['accepted', 'rejected', 'waitlisted', 'draft'];
      const labels = ['Accepted', 'Rejected', 'Waitlisted', 'In Progress'];

      let html = '';
      for (let i = 0; i < statuses.length; i++) {
        const count = applications.filter(a => a.status === statuses[i]).length;
        html += `<div class="dash__stat">
          <div class="dash__stat-num">${count}</div>
          <div class="dash__stat-label">${labels[i]}</div>
        </div>`;
      }
      statsGrid.innerHTML = html;
    }

    function renderTable() {
      const query = searchInput.value.toLowerCase().trim();
      const statusVal = filterStatus.value;

      const filtered = applications.filter(app => {
        if (statusVal && app.status !== statusVal) return false;
        if (query) {
          const name = (app.full_name || app.profiles?.full_name || '').toLowerCase();
          const email = (app.profiles?.email || '').toLowerCase();
          const major = (app.major_minor || '').toLowerCase();
          if (!name.includes(query) && !email.includes(query) && !major.includes(query)) return false;
        }
        return true;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyMsg.style.display = 'block';
        return;
      }

      emptyMsg.style.display = 'none';
      tbody.innerHTML = filtered.map(app => {
        const name = app.full_name || app.profiles?.full_name || '—';
        const email = app.profiles?.email || '—';
        const major = app.major_minor || '—';
        const year = app.current_year || '—';
        const submitted = app.submitted_at ? new Date(app.submitted_at).toLocaleDateString() : '—';
        const checked = selectedIds.has(app.id) ? 'checked' : '';

        return `<tr data-id="${app.id}">
          <td><input type="checkbox" class="row-check" data-id="${app.id}" ${checked} /></td>
          <td>${esc(name)}</td>
          <td>${esc(email)}</td>
          <td>${esc(major)}</td>
          <td>${esc(year)}</td>
          <td><span class="status-badge status-badge--${app.status}">${app.status === 'draft' ? 'in progress' : app.status === 'submitted' ? 'pending' : app.status.replace('_', ' ')}</span></td>
          <td>${submitted}</td>
        </tr>`;
      }).join('');

      tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', (e) => {
          if ((e.target as HTMLElement).tagName === 'INPUT') return;
          openDetail(row.dataset.id!);
        });
      });

      tbody.querySelectorAll<HTMLInputElement>('.row-check').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) selectedIds.add(cb.dataset.id!);
          else selectedIds.delete(cb.dataset.id!);
          updateBulkBar();
        });
      });
    }

    function updateBulkBar() {
      if (selectedIds.size > 0) {
        bulkBar.classList.add('dash__bulk--visible');
        bulkCount.textContent = `${selectedIds.size} selected`;
      } else {
        bulkBar.classList.remove('dash__bulk--visible');
      }
    }

    async function openDetail(appId: string) {
      openAppId = appId;
      const app = applications.find(a => a.id === appId);
      if (!app) return;

      const content = document.getElementById('detail-content')!;
      const field = (label: string, value: string | null | undefined) => {
        if (!value) return '';
        return `<div class="dash__detail-field">
          <div class="dash__detail-label">${label}</div>
          <div class="dash__detail-value">${esc(value)}</div>
        </div>`;
      };

      const name = app.full_name || app.profiles?.full_name || 'Unknown';
      content.innerHTML = `
        <div class="dash__detail-name">${esc(name)}</div>
        ${field('Email', app.profiles?.email)}
        ${field('UID', app.uid)}
        ${field('Major / Minor', app.major_minor)}
        ${field('Current Year', app.current_year)}
        ${field('Student Status', app.student_status)}
        ${field('Graduation Year', app.graduation_year?.toString())}
        ${field('Relevant Experience', app.relevant_experience)}
        ${field('Current Commitments', app.current_commitments)}
        ${field('Your Story', app.your_story)}
        ${field('Your Dream', app.your_dream)}
        ${field('Proud of Building', app.proud_of_building)}
        ${field('Natural Skills', app.natural_skills)}
        ${field('Uncertainty & Failures', app.uncertainty_failures)}
        ${field('Leadership Experiences', app.leadership_experiences)}
        ${field('Interest in XR', app.interest_in_xr)}
        ${field('Attended Kick Off', (app as any).attended_kickoff)}
        ${field('Member 1+ Year', (app as any).member_over_year)}
        ${field('LinkedIn', app.linkedin_url)}
        ${field('GitHub', app.github_url)}
        ${field('Portfolio', app.portfolio_url)}
        ${field('Submitted', app.submitted_at ? new Date(app.submitted_at).toLocaleString() : null)}
      `;

      const statusSelect = document.getElementById('detail-status') as HTMLSelectElement;
      statusSelect.value = app.status;

      const dlLink = document.getElementById('download-resume');
      if (dlLink && app.resume_path) {
        dlLink.addEventListener('click', async (e) => {
          e.preventDefault();
          const { data } = await supabase.storage.from('resumes').createSignedUrl(app.resume_path!, 60);
          if (data?.signedUrl) window.open(data.signedUrl, '_blank');
        });
      }

      await loadNotes(appId);

      detailPanel.classList.add('dash__detail--open');
    }

    async function loadNotes(appId: string) {
      const notesList = document.getElementById('notes-list')!;
      const { data: notes } = await supabase
        .from('admin_notes')
        .select('*, profiles:author_id(full_name)')
        .eq('application_id', appId)
        .order('created_at', { ascending: false });

      if (!notes || notes.length === 0) {
        notesList.innerHTML = '<p style="font-size:0.8rem; color:rgba(255,255,255,0.3);">No notes yet.</p>';
        return;
      }

      notesList.innerHTML = (notes as any[]).map(n => `
        <div class="dash__note">
          <div class="dash__note-meta">${esc(n.profiles?.full_name || 'Unknown')} · ${new Date(n.created_at).toLocaleString()}</div>
          <div class="dash__note-content">${esc(n.content)}</div>
        </div>
      `).join('');
    }

    async function loadActivityLog() {
      const list = document.getElementById('activity-list')!;
      const emptyEl = document.getElementById('activity-empty')!;

      const { data: entries } = await supabase
        .from('activity_log')
        .select('*, profiles:actor_id(full_name)')
        .order('created_at', { ascending: false })
        .limit(100);

      if (!entries || entries.length === 0) {
        list.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      list.innerHTML = (entries as any[]).map(e => `
        <div class="dash__activity-item">
          <div class="dash__activity-dot"></div>
          <div>
            <div class="dash__activity-text"><strong>${esc(e.profiles?.full_name || 'Unknown')}</strong> ${esc(e.action)}</div>
            <div class="dash__activity-time">${new Date(e.created_at).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    }

    // ── Bind all DOM refs + event listeners on every navigation ──
    document.addEventListener('astro:page-load', () => {
      // Only run on dashboard page
      if (!document.getElementById('dash')) return;

      loadingState = document.getElementById('loading-state')!;
      dash = document.getElementById('dash')!;
      tbody = document.getElementById('app-tbody')!;
      searchInput = document.getElementById('search-input') as HTMLInputElement;
      filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
      statsGrid = document.getElementById('stats-grid')!;
      emptyMsg = document.getElementById('empty-msg')!;
      selectAll = document.getElementById('select-all') as HTMLInputElement;
      bulkBar = document.getElementById('bulk-bar')!;
      bulkCount = document.getElementById('bulk-count')!;
      detailPanel = document.getElementById('detail-panel')!;

      // Reset state
      selectedIds = new Set();
      openAppId = null;

      // ── Init: auth check + load data ──
      (async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { window.location.href = `${base}login`; return; }

        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (!profile || (profile.role !== 'board' && profile.role !== 'admin')) {
          window.location.href = base;
          return;
        }

        currentUser = profile as Profile;
        document.getElementById('user-name')!.textContent = currentUser.full_name;
        const roleLabels: Record<string, string> = { board: 'Board Member', admin: 'Board Member' };
        document.getElementById('user-role')!.textContent = roleLabels[currentUser.role] || currentUser.role;

        loadingState.style.display = 'none';
        dash.style.display = 'flex';

        await loadApplications();
        await loadStats();
      })();

      // ── Event listeners ──
      searchInput.addEventListener('input', renderTable);
      filterStatus.addEventListener('change', renderTable);

      selectAll.addEventListener('change', () => {
        const checks = tbody.querySelectorAll<HTMLInputElement>('.row-check');
        checks.forEach(cb => {
          cb.checked = selectAll.checked;
          if (selectAll.checked) selectedIds.add(cb.dataset.id!);
          else selectedIds.delete(cb.dataset.id!);
        });
        updateBulkBar();
      });

      document.getElementById('bulk-apply-btn')!.addEventListener('click', async () => {
        const newStatus = (document.getElementById('bulk-status-select') as HTMLSelectElement).value;
        if (!newStatus || selectedIds.size === 0) return;

        for (const id of selectedIds) {
          await supabase.from('applications').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', id);

          await supabase.from('activity_log').insert({
            actor_id: currentUser!.id,
            action: `Changed status to ${newStatus}`,
            target_application_id: id,
            details: { new_status: newStatus },
          });
        }

        selectedIds.clear();
        updateBulkBar();
        selectAll.checked = false;
        await loadApplications();
        await loadStats();
      });

      document.getElementById('export-btn')!.addEventListener('click', () => {
        const headers = ['Name', 'Email', 'UID', 'Major/Minor', 'Year', 'Student Status', 'Graduation', 'Relevant Experience', 'Current Commitments', 'Your Story', 'Your Dream', 'Proud of Building', 'Natural Skills', 'Uncertainty & Failures', 'Leadership', 'Interest in XR', 'Attended Kick Off', 'Member 1+ Year', 'LinkedIn', 'GitHub', 'Portfolio', 'Status', 'Submitted'];
        const rows = applications.map(a => [
          a.full_name || a.profiles?.full_name || '',
          a.profiles?.email || '',
          a.uid || '',
          a.major_minor || '',
          a.current_year || '',
          a.student_status || '',
          a.graduation_year?.toString() || '',
          (a.relevant_experience || '').replace(/\n/g, ' '),
          (a.current_commitments || '').replace(/\n/g, ' '),
          (a.your_story || '').replace(/\n/g, ' '),
          (a.your_dream || '').replace(/\n/g, ' '),
          (a.proud_of_building || '').replace(/\n/g, ' '),
          (a.natural_skills || '').replace(/\n/g, ' '),
          (a.uncertainty_failures || '').replace(/\n/g, ' '),
          (a.leadership_experiences || '').replace(/\n/g, ' '),
          (a.interest_in_xr || '').replace(/\n/g, ' '),
          (a as any).attended_kickoff || '',
          (a as any).member_over_year || '',
          a.linkedin_url || '',
          a.github_url || '',
          a.portfolio_url || '',
          a.status,
          a.submitted_at ? new Date(a.submitted_at).toLocaleDateString() : '',
        ]);

        const csv = [headers, ...rows].map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(',')).join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `xr-club-applications-${new Date().toISOString().slice(0, 10)}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('detail-close')!.addEventListener('click', () => {
        detailPanel.classList.remove('dash__detail--open');
        openAppId = null;
      });

      document.getElementById('detail-status')!.addEventListener('change', async (e) => {
        if (!openAppId) return;
        const newStatus = (e.target as HTMLSelectElement).value;

        await supabase
          .from('applications')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', openAppId);

        await supabase.from('activity_log').insert({
          actor_id: currentUser!.id,
          action: `Changed status to ${newStatus}`,
          target_application_id: openAppId,
          details: { new_status: newStatus },
        });

        await loadApplications();
        await loadStats();
      });

      document.getElementById('add-note-btn')!.addEventListener('click', async () => {
        if (!openAppId || !currentUser) return;
        const input = document.getElementById('note-input') as HTMLTextAreaElement;
        const content = input.value.trim();
        if (!content) return;

        await supabase.from('admin_notes').insert({
          application_id: openAppId,
          author_id: currentUser.id,
          content,
        });

        await supabase.from('activity_log').insert({
          actor_id: currentUser.id,
          action: 'Added a note',
          target_application_id: openAppId,
          details: { note_preview: content.slice(0, 100) },
        });

        input.value = '';
        await loadNotes(openAppId);
      });

      document.getElementById('delete-app-btn')!.addEventListener('click', async () => {
        if (!openAppId || !currentUser) return;
        const app = applications.find(a => a.id === openAppId);
        const appName = app?.full_name || app?.profiles?.full_name || 'this applicant';
        if (!confirm(`Delete ${appName}'s application? This cannot be undone. They will need to submit a new one.`)) return;

        const { error } = await supabase.functions.invoke('delete-application', {
          body: { application_id: openAppId },
        });

        if (error) {
          alert('Failed to delete application: ' + error.message);
          return;
        }

        await supabase.from('activity_log').insert({
          actor_id: currentUser.id,
          action: `Deleted application for ${appName}`,
          target_application_id: null,
          details: { deleted_name: appName },
        });

        detailPanel.classList.remove('dash__detail--open');
        openAppId = null;
        await loadApplications();
        await loadStats();
      });

      document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', async () => {
          document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('dash__nav-link--active'));
          tab.classList.add('dash__nav-link--active');

          const target = (tab as HTMLElement).dataset.tab;
          const appView = document.getElementById('applications-view')!;
          const actView = document.getElementById('activity-view')!;

          if (target === 'applications') {
            appView.style.display = 'block';
            actView.classList.remove('dash__activity--visible');
          } else if (target === 'activity') {
            appView.style.display = 'none';
            actView.classList.add('dash__activity--visible');
            await loadActivityLog();
          }
        });
      });

      document.getElementById('logout-btn')!.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = base;
      });
    });
  </script>
</AppLayout>
