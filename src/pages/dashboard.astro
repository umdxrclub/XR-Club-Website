---
import AppLayout from '../layouts/AppLayout.astro';
const base = import.meta.env.BASE_URL;
---

<AppLayout title="Dashboard — XR Club" hideHeader hideChatBot>
  <div class="auth-page" id="loading-state">
    <div class="auth-card" style="text-align:center;">
      <span class="auth-spinner"></span>
      <p class="auth-card__subtitle" style="margin-top:1rem;">Loading dashboard…</p>
    </div>
  </div>

  <div class="dash" id="dash" style="display:none;">
    <aside class="dash__sidebar">
      <div class="dash__sidebar-header">
        <div class="dash__user-name" id="user-name"></div>
        <div class="dash__user-role" id="user-role"></div>
      </div>

      <nav class="dash__nav">
        <div class="dash__nav-link dash__nav-link--active" data-tab="applications">Applications</div>
        <div class="dash__nav-link" data-tab="projects">Projects</div>
        <div class="dash__nav-link" data-tab="activity">Activity Log</div>
        <a href={base} class="dash__nav-link">Back to Site</a>
      </nav>

      <div class="dash__sidebar-footer">
        <button class="dash__logout" id="logout-btn">Sign Out</button>
      </div>
    </aside>

    <main class="dash__main">
      <div id="applications-view">
        <h1 class="dash__title">Applications</h1>

        <div class="dash__stats" id="stats-grid"></div>

        <div class="dash__bulk" id="bulk-bar">
          <span class="dash__bulk-count" id="bulk-count">0 selected</span>
          <select class="dash__bulk-select" id="bulk-status-select">
            <option value="">Change status to…</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="waitlisted">Waitlisted</option>
          </select>
          <button class="dash__bulk-btn" id="bulk-apply-btn">Apply</button>
        </div>

        <div class="dash__toolbar">
          <input class="dash__search" type="text" id="search-input" placeholder="Search by name, email, or major…" />
          <select class="dash__filter" id="filter-status">
            <option value="">All Statuses</option>
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="waitlisted">Waitlisted</option>
            <option value="draft">In Progress</option>
          </select>
          <button class="dash__export-btn" id="export-btn">Export Excel</button>
        </div>

        <table class="dash__table" id="app-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" /></th>
              <th>Name</th>
              <th>Email</th>
              <th>Major</th>
              <th>Year</th>
              <th>Status</th>
              <th>Submitted</th>
            </tr>
          </thead>
          <tbody id="app-tbody"></tbody>
        </table>

        <div class="dash__empty" id="empty-msg" style="display:none;">No applications found.</div>
      </div>

      <div id="activity-view" class="dash__activity">
        <h1 class="dash__title">Activity Log</h1>
        <div id="activity-list"></div>
        <div class="dash__empty" id="activity-empty" style="display:none;">No activity yet.</div>
      </div>

      <div id="projects-view" class="dash__projects-view">
        <h1 class="dash__title">Projects</h1>
        <div class="dash__toolbar">
          <button class="dash__export-btn" id="add-project-btn">+ Add Project</button>
        </div>
        <div class="dash__projects-grid" id="dash-projects-grid"></div>
        <div class="dash__empty" id="projects-empty" style="display:none;">No projects yet.</div>
      </div>
    </main>

    <div class="dash__detail" id="detail-panel">
      <div class="dash__detail-inner">
        <button class="dash__detail-close" id="detail-close">&times;</button>
        <div id="detail-content"></div>

        <div class="dash__detail-field">
          <div class="dash__detail-label">Status</div>
          <select class="dash__detail-status" id="detail-status">
            <option value="accepted">Accepted</option>
            <option value="rejected">Rejected</option>
            <option value="waitlisted">Waitlisted</option>
          </select>
        </div>

        <div class="dash__notes">
          <div class="dash__notes-title">Notes</div>
          <div id="notes-list"></div>
          <textarea class="dash__note-input" id="note-input" placeholder="Add a note…"></textarea>
          <button class="dash__note-btn" id="add-note-btn">Add Note</button>
        </div>

        <div class="dash__danger-zone">
          <button class="dash__delete-btn" id="delete-app-btn">Delete Application</button>
        </div>
      </div>
    </div>

    <div class="dash__detail" id="project-edit-panel">
      <div class="dash__detail-inner">
        <button class="dash__detail-close" id="project-edit-close">&times;</button>
        <div class="dash__detail-name" id="project-edit-title">New Project</div>

        <div class="dash__detail-field">
          <div class="dash__detail-label">Name</div>
          <input class="dash__search" id="pe-name" placeholder="Project name" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Blurb</div>
          <textarea class="dash__note-input" id="pe-blurb" style="min-height:100px;" placeholder="Project description..."></textarea>
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Tier</div>
          <select class="dash__detail-status" id="pe-tier">
            <option value="Gateway">Gateway</option>
            <option value="Intermediate">Intermediate</option>
            <option value="Advanced">Advanced</option>
          </select>
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Labels (comma-separated)</div>
          <input class="dash__search" id="pe-labels" placeholder="No-Code, Partnership" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Equipment</div>
          <input class="dash__search" id="pe-equipment" placeholder="Quest 3" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Estimated Completion</div>
          <input class="dash__search" id="pe-completion" placeholder="May 2026" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Contact Name</div>
          <input class="dash__search" id="pe-contact-name" placeholder="Name" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Contact Email</div>
          <input class="dash__search" id="pe-contact-email" type="email" placeholder="email@umd.edu" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Team Members (comma-separated)</div>
          <input class="dash__search" id="pe-people" placeholder="Name 1, Name 2" style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Open Positions</div>
          <textarea class="dash__note-input" id="pe-positions" placeholder="Description of open roles..."></textarea>
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Prompt Question (for applicants)</div>
          <textarea class="dash__note-input" id="pe-prompt" placeholder="Custom question..."></textarea>
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Website</div>
          <input class="dash__search" id="pe-website" type="url" placeholder="https://..." style="width:100%;" />
        </div>
        <div class="dash__detail-field">
          <div class="dash__detail-label">Display Order</div>
          <input class="dash__search" id="pe-order" type="number" value="0" style="width:80px;" />
        </div>

        <div style="display:flex;gap:0.5rem;margin-top:1rem;">
          <button class="dash__note-btn" id="pe-save-btn">Save Project</button>
          <button class="dash__note-btn" id="pe-toggle-btn">Hide</button>
        </div>

        <div class="dash__danger-zone">
          <button class="dash__delete-btn" id="pe-delete-btn">Delete Project</button>
        </div>
      </div>
    </div>
  </div>

  <img src={`${base}Images/ado wong.webp`} alt="Ado Wong" class="dash__ado-wong" />

  <script>
    import { supabase } from '../lib/supabase';
    import type { Application, Profile, Project } from '../lib/types';

    const base = import.meta.env.BASE_URL;
    let currentUser: Profile | null = null;
    let applications: (Application & { profiles?: { full_name: string; email: string } })[] = [];
    let selectedIds = new Set<string>();
    let openAppId: string | null = null;
    let dashProjects: Project[] = [];
    let editingProjectId: string | null = null;

    // DOM refs — refreshed on every page load
    let loadingState: HTMLElement;
    let dash: HTMLElement;
    let tbody: HTMLElement;
    let searchInput: HTMLInputElement;
    let filterStatus: HTMLSelectElement;
    let statsGrid: HTMLElement;
    let emptyMsg: HTMLElement;
    let selectAll: HTMLInputElement;
    let bulkBar: HTMLElement;
    let bulkCount: HTMLElement;
    let detailPanel: HTMLElement;

    function esc(s: string) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function loadApplications() {
      const { data } = await supabase
        .from('applications')
        .select('*, profiles(full_name, email)')
        .order('submitted_at', { ascending: false, nullsFirst: false });

      applications = (data || []) as typeof applications;
      renderTable();
    }

    async function loadStats() {
      const statuses = ['accepted', 'rejected', 'waitlisted', 'draft'];
      const labels = ['Accepted', 'Rejected', 'Waitlisted', 'In Progress'];

      let html = '';
      for (let i = 0; i < statuses.length; i++) {
        const count = applications.filter(a => a.status === statuses[i]).length;
        html += `<div class="dash__stat">
          <div class="dash__stat-num">${count}</div>
          <div class="dash__stat-label">${labels[i]}</div>
        </div>`;
      }
      statsGrid.innerHTML = html;
    }

    function renderTable() {
      const query = searchInput.value.toLowerCase().trim();
      const statusVal = filterStatus.value;

      const filtered = applications.filter(app => {
        if (statusVal && app.status !== statusVal) return false;
        if (query) {
          const name = (app.full_name || app.profiles?.full_name || '').toLowerCase();
          const email = (app.profiles?.email || '').toLowerCase();
          const major = (app.major_minor || '').toLowerCase();
          if (!name.includes(query) && !email.includes(query) && !major.includes(query)) return false;
        }
        return true;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyMsg.style.display = 'block';
        return;
      }

      emptyMsg.style.display = 'none';
      tbody.innerHTML = filtered.map(app => {
        const name = app.full_name || app.profiles?.full_name || '—';
        const email = app.profiles?.email || '—';
        const major = app.major_minor || '—';
        const year = app.current_year || '—';
        const submitted = app.submitted_at ? new Date(app.submitted_at).toLocaleDateString() : '—';
        const checked = selectedIds.has(app.id) ? 'checked' : '';

        return `<tr data-id="${app.id}">
          <td><input type="checkbox" class="row-check" data-id="${app.id}" ${checked} /></td>
          <td>${esc(name)}</td>
          <td>${esc(email)}</td>
          <td>${esc(major)}</td>
          <td>${esc(year)}</td>
          <td><span class="status-badge status-badge--${app.status}">${app.status === 'draft' ? 'in progress' : app.status === 'submitted' ? 'pending' : app.status.replace('_', ' ')}</span></td>
          <td>${submitted}</td>
        </tr>`;
      }).join('');

      tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', (e) => {
          if ((e.target as HTMLElement).tagName === 'INPUT') return;
          openDetail(row.dataset.id!);
        });
      });

      tbody.querySelectorAll<HTMLInputElement>('.row-check').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) selectedIds.add(cb.dataset.id!);
          else selectedIds.delete(cb.dataset.id!);
          updateBulkBar();
        });
      });
    }

    function updateBulkBar() {
      if (selectedIds.size > 0) {
        bulkBar.classList.add('dash__bulk--visible');
        bulkCount.textContent = `${selectedIds.size} selected`;
      } else {
        bulkBar.classList.remove('dash__bulk--visible');
      }
    }

    async function openDetail(appId: string) {
      openAppId = appId;
      const app = applications.find(a => a.id === appId);
      if (!app) return;

      const content = document.getElementById('detail-content')!;
      const field = (label: string, value: string | null | undefined) => {
        if (!value) return '';
        return `<div class="dash__detail-field">
          <div class="dash__detail-label">${label}</div>
          <div class="dash__detail-value">${esc(value)}</div>
        </div>`;
      };

      const name = app.full_name || app.profiles?.full_name || 'Unknown';
      content.innerHTML = `
        <div class="dash__detail-name">${esc(name)}</div>
        ${field('Email', app.profiles?.email)}
        ${field('UID', app.uid)}
        ${field('Major / Minor', app.major_minor)}
        ${field('Current Year', app.current_year)}
        ${field('Student Status', app.student_status)}
        ${field('Graduation Year', app.graduation_year?.toString())}
        ${field('Relevant Experience', app.relevant_experience)}
        ${field('Current Commitments', app.current_commitments)}
        ${field('Your Story', app.your_story)}
        ${field('Your Dream', app.your_dream)}
        ${field('Proud of Building', app.proud_of_building)}
        ${field('Natural Skills', app.natural_skills)}
        ${field('Uncertainty & Failures', app.uncertainty_failures)}
        ${field('Leadership Experiences', app.leadership_experiences)}
        ${field('Interest in XR', app.interest_in_xr)}
        ${field('Attended Kick Off', (app as any).attended_kickoff)}
        ${field('Member 1+ Year', (app as any).member_over_year)}
        ${field('LinkedIn', app.linkedin_url)}
        ${field('GitHub', app.github_url)}
        ${field('Portfolio', app.portfolio_url)}
        ${field('Submitted', app.submitted_at ? new Date(app.submitted_at).toLocaleString() : null)}
      `;

      const statusSelect = document.getElementById('detail-status') as HTMLSelectElement;
      statusSelect.value = app.status;

      const dlLink = document.getElementById('download-resume');
      if (dlLink && app.resume_path) {
        dlLink.addEventListener('click', async (e) => {
          e.preventDefault();
          const { data } = await supabase.storage.from('resumes').createSignedUrl(app.resume_path!, 60);
          if (data?.signedUrl) window.open(data.signedUrl, '_blank');
        });
      }

      // Load project selections for this applicant
      const { data: selections } = await supabase
        .from('project_selections')
        .select('*, projects(name, tier)')
        .eq('application_id', appId)
        .order('rank');

      if (selections && selections.length > 0) {
        const tierStyle: Record<string, string> = {
          Gateway: 'color:#34d399;background:rgba(52,211,153,0.1);',
          Intermediate: 'color:#fbbf24;background:rgba(251,191,36,0.1);',
          Advanced: 'color:#f87171;background:rgba(248,113,113,0.1);',
        };
        let projectHtml = '<div class="dash__detail-field"><div class="dash__detail-label">Project Preferences</div>';
        (selections as any[]).forEach(s => {
          const ordinal = s.rank === 1 ? '1st' : s.rank === 2 ? '2nd' : '3rd';
          const tier = s.projects?.tier || '';
          const tStyle = tierStyle[tier] || 'color:rgba(255,255,255,0.5);';
          projectHtml += `
            <div style="margin-bottom:0.7rem;padding:0.8rem 1rem;background:rgba(255,255,255,0.025);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
              <div style="display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.35rem;">
                <span style="font-size:0.6rem;font-weight:700;color:#34d399;text-transform:uppercase;letter-spacing:0.06em;">${ordinal} Choice</span>
                ${tier ? `<span style="font-size:0.5rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;padding:0.1rem 0.4rem;border-radius:3px;${tStyle}">${esc(tier)}</span>` : ''}
              </div>
              <div style="font-size:1rem;font-weight:700;color:#fff;letter-spacing:-0.02em;">${esc(s.projects?.name || 'Unknown')}</div>
              ${s.prompt_answer ? `<div style="font-size:0.82rem;color:rgba(255,255,255,0.45);margin-top:0.5rem;line-height:1.6;white-space:pre-wrap;">${esc(s.prompt_answer)}</div>` : ''}
            </div>`;
        });
        projectHtml += '</div>';
        content.innerHTML += projectHtml;
      }

      await loadNotes(appId);

      detailPanel.classList.add('dash__detail--open');
    }

    async function loadNotes(appId: string) {
      const notesList = document.getElementById('notes-list')!;
      const { data: notes } = await supabase
        .from('admin_notes')
        .select('*, profiles:author_id(full_name)')
        .eq('application_id', appId)
        .order('created_at', { ascending: false });

      if (!notes || notes.length === 0) {
        notesList.innerHTML = '<p style="font-size:0.8rem; color:rgba(255,255,255,0.3);">No notes yet.</p>';
        return;
      }

      notesList.innerHTML = (notes as any[]).map(n => `
        <div class="dash__note">
          <div class="dash__note-meta">${esc(n.profiles?.full_name || 'Unknown')} · ${new Date(n.created_at).toLocaleString()}</div>
          <div class="dash__note-content">${esc(n.content)}</div>
        </div>
      `).join('');
    }

    async function loadActivityLog() {
      const list = document.getElementById('activity-list')!;
      const emptyEl = document.getElementById('activity-empty')!;

      const { data: entries } = await supabase
        .from('activity_log')
        .select('*, profiles:actor_id(full_name)')
        .order('created_at', { ascending: false })
        .limit(100);

      if (!entries || entries.length === 0) {
        list.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      list.innerHTML = (entries as any[]).map(e => `
        <div class="dash__activity-item">
          <div class="dash__activity-dot"></div>
          <div>
            <div class="dash__activity-text"><strong>${esc(e.profiles?.full_name || 'Unknown')}</strong> ${esc(e.action)}</div>
            <div class="dash__activity-time">${new Date(e.created_at).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    }

    // ── Project Management ──
    async function loadDashProjects() {
      const grid = document.getElementById('dash-projects-grid')!;
      const emptyEl = document.getElementById('projects-empty')!;

      const { data } = await supabase
        .from('projects')
        .select('*')
        .order('display_order');

      dashProjects = (data || []) as Project[];

      if (dashProjects.length === 0) {
        grid.innerHTML = '';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      grid.innerHTML = dashProjects.map(p => {
        const tierColors: Record<string, string> = { Gateway: '#34d399', Intermediate: '#fbbf24', Advanced: '#f87171' };
        const color = tierColors[p.tier] || '#fff';
        const activeLabel = p.is_active ? '' : '<span style="color:#f87171;font-size:0.7rem;font-weight:600;margin-left:0.5rem;">HIDDEN</span>';
        return `
          <div class="dash__project-card" data-project-id="${p.id}" style="cursor:pointer;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:0.5rem;">
              <div style="font-size:0.9rem;font-weight:600;color:#fff;">${esc(p.name)}${activeLabel}</div>
              <span style="font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:${color};border:1px solid ${color}33;padding:0.15rem 0.5rem;border-radius:980px;">${esc(p.tier)}</span>
            </div>
            <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:0.3rem;">${esc(p.contact_name)} · ${esc(p.equipment)}</div>
          </div>`;
      }).join('');

      grid.querySelectorAll('.dash__project-card').forEach(card => {
        card.addEventListener('click', () => {
          openProjectEditor((card as HTMLElement).dataset.projectId!);
        });
      });
    }

    function openProjectEditor(projectId: string | null) {
      const panel = document.getElementById('project-edit-panel')!;
      editingProjectId = projectId;

      const project = projectId ? dashProjects.find(p => p.id === projectId) : null;
      const title = document.getElementById('project-edit-title')!;
      title.textContent = project ? 'Edit Project' : 'New Project';

      (document.getElementById('pe-name') as HTMLInputElement).value = project?.name || '';
      (document.getElementById('pe-blurb') as HTMLTextAreaElement).value = project?.blurb || '';
      (document.getElementById('pe-tier') as HTMLSelectElement).value = project?.tier || 'Gateway';
      (document.getElementById('pe-labels') as HTMLInputElement).value = project?.labels?.join(', ') || '';
      (document.getElementById('pe-equipment') as HTMLInputElement).value = project?.equipment || '';
      (document.getElementById('pe-completion') as HTMLInputElement).value = project?.estimated_completion || '';
      (document.getElementById('pe-contact-name') as HTMLInputElement).value = project?.contact_name || '';
      (document.getElementById('pe-contact-email') as HTMLInputElement).value = project?.contact_email || '';
      (document.getElementById('pe-people') as HTMLInputElement).value = project?.people?.join(', ') || '';
      (document.getElementById('pe-positions') as HTMLTextAreaElement).value = project?.open_positions || '';
      (document.getElementById('pe-prompt') as HTMLTextAreaElement).value = project?.prompt_question || 'Why do you want to join this project and what would you contribute?';
      (document.getElementById('pe-website') as HTMLInputElement).value = project?.website || '';
      (document.getElementById('pe-order') as HTMLInputElement).value = String(project?.display_order ?? 0);

      const toggleBtn = document.getElementById('pe-toggle-btn')!;
      toggleBtn.textContent = project?.is_active === false ? 'Unhide' : 'Hide';

      const deleteBtn = document.getElementById('pe-delete-btn')!;
      deleteBtn.style.display = project ? 'block' : 'none';

      panel.classList.add('dash__detail--open');
    }

    async function saveProject() {
      const name = (document.getElementById('pe-name') as HTMLInputElement).value.trim();
      if (!name) { alert('Project name is required.'); return; }

      const payload = {
        name,
        blurb: (document.getElementById('pe-blurb') as HTMLTextAreaElement).value.trim(),
        tier: (document.getElementById('pe-tier') as HTMLSelectElement).value,
        labels: (document.getElementById('pe-labels') as HTMLInputElement).value.split(',').map(s => s.trim()).filter(Boolean),
        equipment: (document.getElementById('pe-equipment') as HTMLInputElement).value.trim(),
        estimated_completion: (document.getElementById('pe-completion') as HTMLInputElement).value.trim(),
        contact_name: (document.getElementById('pe-contact-name') as HTMLInputElement).value.trim(),
        contact_email: (document.getElementById('pe-contact-email') as HTMLInputElement).value.trim(),
        people: (document.getElementById('pe-people') as HTMLInputElement).value.split(',').map(s => s.trim()).filter(Boolean),
        open_positions: (document.getElementById('pe-positions') as HTMLTextAreaElement).value.trim() || null,
        prompt_question: (document.getElementById('pe-prompt') as HTMLTextAreaElement).value.trim(),
        website: (document.getElementById('pe-website') as HTMLInputElement).value.trim() || null,
        display_order: parseInt((document.getElementById('pe-order') as HTMLInputElement).value) || 0,
        updated_at: new Date().toISOString(),
      };

      if (editingProjectId) {
        await supabase.from('projects').update(payload).eq('id', editingProjectId);
      } else {
        await supabase.from('projects').insert(payload);
      }

      document.getElementById('project-edit-panel')!.classList.remove('dash__detail--open');
      editingProjectId = null;
      await loadDashProjects();
    }

    async function toggleProjectActive() {
      if (!editingProjectId) return;
      const project = dashProjects.find(p => p.id === editingProjectId);
      if (!project) return;

      await supabase.from('projects').update({
        is_active: !project.is_active,
        updated_at: new Date().toISOString(),
      }).eq('id', editingProjectId);

      document.getElementById('project-edit-panel')!.classList.remove('dash__detail--open');
      editingProjectId = null;
      await loadDashProjects();
    }

    async function deleteProject() {
      if (!editingProjectId) return;
      const project = dashProjects.find(p => p.id === editingProjectId);
      if (!confirm(`Delete "${project?.name}"? This cannot be undone.`)) return;

      await supabase.from('project_selections').delete().eq('project_id', editingProjectId);
      await supabase.from('projects').delete().eq('id', editingProjectId);

      document.getElementById('project-edit-panel')!.classList.remove('dash__detail--open');
      editingProjectId = null;
      await loadDashProjects();
    }

    // ── Bind all DOM refs + event listeners on every navigation ──
    document.addEventListener('astro:page-load', () => {
      // Only run on dashboard page
      if (!document.getElementById('dash')) return;

      loadingState = document.getElementById('loading-state')!;
      dash = document.getElementById('dash')!;
      tbody = document.getElementById('app-tbody')!;
      searchInput = document.getElementById('search-input') as HTMLInputElement;
      filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
      statsGrid = document.getElementById('stats-grid')!;
      emptyMsg = document.getElementById('empty-msg')!;
      selectAll = document.getElementById('select-all') as HTMLInputElement;
      bulkBar = document.getElementById('bulk-bar')!;
      bulkCount = document.getElementById('bulk-count')!;
      detailPanel = document.getElementById('detail-panel')!;

      // Reset state
      selectedIds = new Set();
      openAppId = null;

      // ── Init: auth check + load data ──
      (async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { window.location.href = `${base}login`; return; }

        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (!profile || (profile.role !== 'board' && profile.role !== 'admin')) {
          window.location.href = base;
          return;
        }

        currentUser = profile as Profile;
        document.getElementById('user-name')!.textContent = currentUser.full_name;
        const roleLabels: Record<string, string> = { board: 'Board Member', admin: 'Board Member' };
        document.getElementById('user-role')!.textContent = roleLabels[currentUser.role] || currentUser.role;

        loadingState.style.display = 'none';
        dash.style.display = 'flex';

        await loadApplications();
        await loadStats();
      })();

      // ── Event listeners ──
      searchInput.addEventListener('input', renderTable);
      filterStatus.addEventListener('change', renderTable);

      selectAll.addEventListener('change', () => {
        const checks = tbody.querySelectorAll<HTMLInputElement>('.row-check');
        checks.forEach(cb => {
          cb.checked = selectAll.checked;
          if (selectAll.checked) selectedIds.add(cb.dataset.id!);
          else selectedIds.delete(cb.dataset.id!);
        });
        updateBulkBar();
      });

      document.getElementById('bulk-apply-btn')!.addEventListener('click', async () => {
        const newStatus = (document.getElementById('bulk-status-select') as HTMLSelectElement).value;
        if (!newStatus || selectedIds.size === 0) return;

        for (const id of selectedIds) {
          await supabase.from('applications').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', id);

          await supabase.from('activity_log').insert({
            actor_id: currentUser!.id,
            action: `Changed status to ${newStatus}`,
            target_application_id: id,
            details: { new_status: newStatus },
          });
        }

        selectedIds.clear();
        updateBulkBar();
        selectAll.checked = false;
        await loadApplications();
        await loadStats();
      });

      document.getElementById('export-btn')!.addEventListener('click', () => {
        const headers = ['Name', 'Email', 'UID', 'Major/Minor', 'Year', 'Student Status', 'Graduation', 'Relevant Experience', 'Current Commitments', 'Your Story', 'Your Dream', 'Proud of Building', 'Natural Skills', 'Uncertainty & Failures', 'Leadership', 'Interest in XR', 'Attended Kick Off', 'Member 1+ Year', 'LinkedIn', 'GitHub', 'Portfolio', 'Status', 'Submitted'];
        const rows = applications.map(a => [
          a.full_name || a.profiles?.full_name || '',
          a.profiles?.email || '',
          a.uid || '',
          a.major_minor || '',
          a.current_year || '',
          a.student_status || '',
          a.graduation_year?.toString() || '',
          (a.relevant_experience || '').replace(/\n/g, ' '),
          (a.current_commitments || '').replace(/\n/g, ' '),
          (a.your_story || '').replace(/\n/g, ' '),
          (a.your_dream || '').replace(/\n/g, ' '),
          (a.proud_of_building || '').replace(/\n/g, ' '),
          (a.natural_skills || '').replace(/\n/g, ' '),
          (a.uncertainty_failures || '').replace(/\n/g, ' '),
          (a.leadership_experiences || '').replace(/\n/g, ' '),
          (a.interest_in_xr || '').replace(/\n/g, ' '),
          (a as any).attended_kickoff || '',
          (a as any).member_over_year || '',
          a.linkedin_url || '',
          a.github_url || '',
          a.portfolio_url || '',
          a.status,
          a.submitted_at ? new Date(a.submitted_at).toLocaleDateString() : '',
        ]);

        const csv = [headers, ...rows].map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(',')).join('\n');
        const bom = '\uFEFF';
        const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `xr-club-applications-${new Date().toISOString().slice(0, 10)}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('detail-close')!.addEventListener('click', () => {
        detailPanel.classList.remove('dash__detail--open');
        openAppId = null;
      });

      // Close on backdrop click
      detailPanel.addEventListener('click', (e) => {
        if (e.target === detailPanel) {
          detailPanel.classList.remove('dash__detail--open');
          openAppId = null;
        }
      });

      document.getElementById('detail-status')!.addEventListener('change', async (e) => {
        if (!openAppId) return;
        const newStatus = (e.target as HTMLSelectElement).value;

        await supabase
          .from('applications')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', openAppId);

        await supabase.from('activity_log').insert({
          actor_id: currentUser!.id,
          action: `Changed status to ${newStatus}`,
          target_application_id: openAppId,
          details: { new_status: newStatus },
        });

        await loadApplications();
        await loadStats();
      });

      document.getElementById('add-note-btn')!.addEventListener('click', async () => {
        if (!openAppId || !currentUser) return;
        const input = document.getElementById('note-input') as HTMLTextAreaElement;
        const content = input.value.trim();
        if (!content) return;

        await supabase.from('admin_notes').insert({
          application_id: openAppId,
          author_id: currentUser.id,
          content,
        });

        await supabase.from('activity_log').insert({
          actor_id: currentUser.id,
          action: 'Added a note',
          target_application_id: openAppId,
          details: { note_preview: content.slice(0, 100) },
        });

        input.value = '';
        await loadNotes(openAppId);
      });

      document.getElementById('delete-app-btn')!.addEventListener('click', async () => {
        if (!openAppId || !currentUser) return;
        const app = applications.find(a => a.id === openAppId);
        const appName = app?.full_name || app?.profiles?.full_name || 'this applicant';
        if (!confirm(`Delete ${appName}'s application? This cannot be undone. They will need to submit a new one.`)) return;

        const { error } = await supabase.functions.invoke('delete-application', {
          body: { application_id: openAppId },
        });

        if (error) {
          alert('Failed to delete application: ' + error.message);
          return;
        }

        await supabase.from('activity_log').insert({
          actor_id: currentUser.id,
          action: `Deleted application for ${appName}`,
          target_application_id: null,
          details: { deleted_name: appName },
        });

        detailPanel.classList.remove('dash__detail--open');
        openAppId = null;
        await loadApplications();
        await loadStats();
      });

      // Project editor buttons
      document.getElementById('add-project-btn')!.addEventListener('click', () => openProjectEditor(null));
      document.getElementById('project-edit-close')!.addEventListener('click', () => {
        document.getElementById('project-edit-panel')!.classList.remove('dash__detail--open');
        editingProjectId = null;
      });

      // Close project editor on backdrop click
      document.getElementById('project-edit-panel')!.addEventListener('click', (e) => {
        if (e.target === document.getElementById('project-edit-panel')) {
          document.getElementById('project-edit-panel')!.classList.remove('dash__detail--open');
          editingProjectId = null;
        }
      });
      document.getElementById('pe-save-btn')!.addEventListener('click', saveProject);
      document.getElementById('pe-toggle-btn')!.addEventListener('click', toggleProjectActive);
      document.getElementById('pe-delete-btn')!.addEventListener('click', deleteProject);

      document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', async () => {
          document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('dash__nav-link--active'));
          tab.classList.add('dash__nav-link--active');

          const target = (tab as HTMLElement).dataset.tab;
          const appView = document.getElementById('applications-view')!;
          const actView = document.getElementById('activity-view')!;
          const projView = document.getElementById('projects-view')!;

          // Hide all views
          appView.style.display = 'none';
          actView.classList.remove('dash__activity--visible');
          projView.classList.remove('dash__projects-view--visible');

          if (target === 'applications') {
            appView.style.display = 'block';
          } else if (target === 'activity') {
            actView.classList.add('dash__activity--visible');
            await loadActivityLog();
          } else if (target === 'projects') {
            projView.classList.add('dash__projects-view--visible');
            await loadDashProjects();
          }
        });
      });

      document.getElementById('logout-btn')!.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = base;
      });
    });
  </script>
</AppLayout>
