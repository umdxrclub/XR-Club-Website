---
import AppLayout from '../layouts/AppLayout.astro';
const base = import.meta.env.BASE_URL;
---

<AppLayout title="Set New Password — XR Club">
  <div class="auth-page">
    <div class="auth-card">
      <img src={`${base}Images/XR Logo.png`} alt="XR Club" class="auth-card__logo" />

      <div id="loading-state">
        <h1 class="auth-card__title">Loading…</h1>
        <p class="auth-card__subtitle"><span class="auth-spinner"></span></p>
      </div>

      <div id="form-state" style="display:none;">
        <h1 class="auth-card__title">Set New Password</h1>
        <p class="auth-card__subtitle">Enter your new password below</p>

        <div id="error-msg" class="auth-card__error" style="display:none;"></div>

        <form id="reset-form" class="auth-form">
          <div class="auth-form__field">
            <label class="auth-form__label" for="password">New Password</label>
            <input
              class="auth-form__input"
              type="password"
              id="password"
              name="password"
              placeholder="At least 6 characters"
              minlength="6"
              required
            />
          </div>

          <div class="auth-form__field">
            <label class="auth-form__label" for="confirm-password">Confirm New Password</label>
            <input
              class="auth-form__input"
              type="password"
              id="confirm-password"
              name="confirm_password"
              placeholder="Re-enter password"
              minlength="6"
              required
            />
          </div>

          <button type="submit" class="auth-form__btn" id="submit-btn">
            Update Password
          </button>
        </form>
      </div>

      <div id="success-state" style="display:none;">
        <h1 class="auth-card__title">Password Updated</h1>
        <div class="auth-card__success">Your password has been reset successfully.</div>
        <a href={`${base}login`} class="auth-form__btn" style="display:inline-block; text-decoration:none; margin-top:1rem; text-align:center;">
          Go to Login
        </a>
      </div>

      <div id="error-state" style="display:none;">
        <h1 class="auth-card__title">Invalid Link</h1>
        <div class="auth-card__error" id="error-state-msg">This reset link is invalid or has expired.</div>
        <p class="auth-card__subtitle" style="margin-top:1rem;">
          <a href={`${base}forgot-password`} class="auth-card__link">Request a new reset link</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    const loadingState = document.getElementById('loading-state')!;
    const formState = document.getElementById('form-state')!;
    const successState = document.getElementById('success-state')!;
    const errorState = document.getElementById('error-state')!;
    const errorMsg = document.getElementById('error-msg')!;
    const form = document.getElementById('reset-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    let sessionReady = false;

    const { data: { subscription } } = supabase.auth.onAuthStateChange((event) => {
      if (event === 'PASSWORD_RECOVERY') {
        sessionReady = true;
        loadingState.style.display = 'none';
        formState.style.display = 'block';
        subscription.unsubscribe();
      }
    });

    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session && !sessionReady) {
        sessionReady = true;
        loadingState.style.display = 'none';
        formState.style.display = 'block';
        subscription.unsubscribe();
      }
    })();

    setTimeout(() => {
      if (!sessionReady) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        subscription.unsubscribe();
      }
    }, 8000);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.style.display = 'none';

      const password = (document.getElementById('password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;

      if (password !== confirmPassword) {
        errorMsg.textContent = 'Passwords do not match.';
        errorMsg.style.display = 'block';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="auth-spinner"></span>Updating…';

      const { error } = await supabase.auth.updateUser({ password });

      if (error) {
        errorMsg.textContent = error.message;
        errorMsg.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update Password';
        return;
      }

      await supabase.auth.signOut();
      formState.style.display = 'none';
      successState.style.display = 'block';
    });
  </script>
</AppLayout>
